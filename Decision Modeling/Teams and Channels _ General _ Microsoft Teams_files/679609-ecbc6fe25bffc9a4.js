"use strict";(this.webpackChunk_msteams_react_web_client=this.webpackChunk_msteams_react_web_client||[]).push([[679609],{671186:(e,t,i)=>{i.d(t,{v6:()=>n,Nr:()=>r,Lx:()=>a,Hy:()=>s,I5:()=>o,XJ:()=>d,yj:()=>h,r2:()=>m,R$:()=>u,BK:()=>g,Rp:()=>S,Q$:()=>f,g0:()=>v,Jr:()=>k,Jh:()=>y,wu:()=>C,qf:()=>b,_l:()=>_});const n="resourceRequiresConsent",r="resourceRequiresMfa",a="InteractionRequired",s="tokenRevoked";var o,c,l;!function(e){e.Chat="chat",e.MeetingChat="meetingChat",e.HoloLensChat="holoLensChat",e.EmbedFeedbackChat="embedFeedbackChat",e.SmartReply="smartReply",e.MeetingPPT="meetingPPT",e.Channel="channel",e.ChannelMeeting="channelMeeting",e.ChannelMeetingPPT="channelMeetingPPT",e.ChatFilesTab="chatFilesTab",e.Unknown="unknown"}(o||(o={})),function(e){e[e.Sharepoint=0]="Sharepoint",e[e.WOPI=1]="WOPI",e[e.Google=2]="Google",e[e.OneDrive=3]="OneDrive",e[e.Recent=4]="Recent",e[e.Aggregate=5]="Aggregate",e[e.FileSystem=6]="FileSystem",e[e.Search=7]="Search",e[e.AllFiles=8]="AllFiles",e[e.SharedWithMe=9]="SharedWithMe"}(c||(c={})),function(e){e[e.Recent=0]="Recent",e[e.Aggregate=1]="Aggregate",e[e.Personal=2]="Personal",e[e.Teams=3]="Teams",e[e.Channels=4]="Channels",e[e.Downloads=5]="Downloads",e[e.PersonalWopi=6]="PersonalWopi",e[e.PersonalGoogle=7]="PersonalGoogle",e[e.CustomSpo=8]="CustomSpo",e[e.SharedWithMe=9]="SharedWithMe",e[e.Chats=10]="Chats"}(l||(l={}));const d=(new Map).set("Sharepoint",c.Sharepoint).set("WOPI",c.WOPI).set("Google",c.Google).set("OneDrive",c.OneDrive).set("Recent",c.Recent).set("Aggregate",c.Aggregate).set("FileSystem",c.FileSystem).set("Search",c.Search).set("AllFiles",c.AllFiles).set("SharedWithMe",c.SharedWithMe);var p,h,m;!function(e){e[e.Sharepoint=0]="Sharepoint",e[e.WopiIntegration=1]="WopiIntegration",e[e.Google=2]="Google"}(p||(p={})),function(e){e.Dropbox="DROPBOX",e.Box="BOX",e.Sharefile="SHAREFILE",e.GoogleDrive="GOOGLEDRIVE",e.Egnyte="EGNYTE"}(h||(h={})),function(e){e.Secure="Secure",e.InvalidFormat="InvalidFormat",e.InvalidProtocol="InvalidProtocol",e.InvalidExternalProviderDomain="InvalidExternalProviderDomain",e.DomainMismatchForDifferentUrl="DomainMismatchForDifferentUrl",e.InvalidInternalDomain="InvalidInternalDomain"}(m||(m={}));const u=new Map;u.set("DROPBOX",p.WopiIntegration).set("BOX",p.WopiIntegration).set("SHAREFILE",p.WopiIntegration).set("EGNYTE",p.WopiIntegration).set("GOOGLEDRIVE",p.Google);const g=new Map;g.set(c.Sharepoint,"Sharepoint").set(c.WOPI,"WOPI").set(c.Google,"Google").set(c.OneDrive,"OneDrive").set(c.Recent,"Recent").set(c.Aggregate,"Aggregate").set(c.FileSystem,"FileSystem").set(c.Search,"Search").set(c.AllFiles,"AllFiles").set(c.SharedWithMe,"SharedWithMe");const S=new Map;S.set("DROPBOX",h.Dropbox).set("BOX",h.Box).set("SHAREFILE",h.Sharefile).set("GOOGLEDRIVE",h.GoogleDrive).set("EGNYTE",h.Egnyte);const f=new Map;f.set("Recent",l.Recent).set("Aggregate",l.Aggregate).set("Personal",l.Personal).set("Teams",l.Teams).set("Channels",l.Channels).set("Downloads",l.Downloads).set("PersonalWopi",l.PersonalWopi).set("PersonalGoogle",l.PersonalGoogle).set("CustomSpo",l.CustomSpo).set("SharedWithMe",l.SharedWithMe).set("Chats",l.Chats);const v=e=>{switch(e){case"BOX":return"BOX";case"DROPBOX":return"DROPBOX";case"EGNYTE":return"EGNYTE";case"GOOGLEDRIVE":return"GOOGLEDRIVE";case"SHAREFILE":return"SHAREFILE";default:throw new Error("Invalid provider code")}},k=e=>{switch(e){case c.Sharepoint:return"Sharepoint";case c.WOPI:return"WOPI";case c.Google:return"Google";case c.OneDrive:return"OneDrive";case c.Recent:return"Recent";case c.Aggregate:return"Aggregate";case c.FileSystem:return"FileSystem";case c.Search:return"Search";case c.AllFiles:return"AllFiles";case c.SharedWithMe:return"SharedWithMe";default:throw new Error("Not a valid provider type")}},y="https://teams.microsoft.com/scripts/items-view-strings.js",C=/[\u202A-\u202E\u2066-\u2069]/g,b="â€ª",_=/[\u0590-\u05FF\u0600-\u06FF\u0700-\u074F\u0750-\u077F\u0780-\u07BF\u07C0-\u07FF\uFB1D-\uFB4F\uFB50-\uFDFF\uFE70-\uFEFF]/},700188:(e,t,i)=>{var n;i.d(t,{Q:()=>n}),function(e){e.Perf="perf",e.Scenario="scenarions",e.Logging="loggingns",e.Heartbeat="heartbeatns",e.Http="httpns",e.UserBI="userbins",e.Endpoint="endpointns"}(n||(n={}))},817542:(e,t,i)=>{i.d(t,{Tn:()=>d,DC:()=>p,Oq:()=>h,wW:()=>m,ni:()=>u,ZU:()=>g});var n=i(657120),r=i(720958),a=i(705382),s=i(700188),o=i(245445),c=i(953730);const l="heartbeat";class d{constructor(e){this.initialized=!1,this.logger=a.MP.default,this.eventDecoratorCallbacks=[],this.flush=()=>this.telemetryProvider.flush(),this.telemetryProvider=e??(0,n.AR)(),(0,r.d)((()=>{this.initialized=!1,this.eventDecoratorCallbacks=[]}))}get sessionId(){return this.telemetryProvider.sessionId}initialize(e,t=a.MP.default){this.initialized||(this.consoleLogger=e,this.consoleLogger.debug("TelemetrySender initialized."),this.logger=t,this.initialized=!0)}static getInstance(){return this.telemetrySender||(this.telemetrySender=new d),this.telemetrySender}registerEventDecorator(e){this.eventDecoratorCallbacks.push(e)}sendTelemetry(e,t,i={},n,r,a,l=""){if(!this.initialized)return;t=t.replace(/\-/g,"_").toLowerCase();const d=e===s.Q.Http?i.resultCode:e===s.Q.Endpoint&&i.result&&c.nW[i.result]?c.nW[i.result].toString():e===s.Q.Endpoint&&i.hasInnerError?"fail":"success",p=o.Z.getInstance().getSampleRate(e,a??t,d);if(p===o.b)return;this.decorateEvent(t,i);const h=this.telemetryProvider.createEvent(e,t,i,n,r,a);h.setProperty("sampleRate",p),this.telemetryProvider.logEvent(this.logger,h,l)}sendScenarioEvent(e,t,i,n,r,a=""){if(!this.initialized)return;const c=e.replace(/\-/g,"_"),l=s.Q.Scenario;let d=o.Z.getInstance().getSampleRate(l,c,i["Scenario.Status"]);if("Scenario.CrossClientMode"in t&&(d=o.Z.getInstance().getCrossClientScenarioSampleRate(i["Scenario.Mode"])??d),d===o.b)return;this.decorateEvent(c,t);const p={...i,...t},h=this.telemetryProvider.createEvent(l,e,p,n,r);h.setProperty("sampleRate",d),this.telemetryProvider.logEvent(this.logger,h,a)}sendHeartbeatEvent(e){if(!this.initialized)return;const t=s.Q.Heartbeat;this.decorateEvent(l,e);const i=this.telemetryProvider.createEvent(t,l,e);this.telemetryProvider.logEvent(this.logger,i,void 0)}sendLoggingEvent(e,t,i,n,r,a){if(!this.initialized)return;const c=s.Q.Logging,l=o.Z.getInstance().getSampleRate(c,i,t.logLevel);if(l===o.b)return;e=e.replace(/\-/g,"_").toLowerCase(),this.decorateEvent(e,t);const d=this.telemetryProvider.createEvent(c,e,t,r,a,i);d.setProperty("sampleRate",l),this.telemetryProvider.logEvent(this.logger,d,n)}decorateEvent(e,t){this.eventDecoratorCallbacks.forEach((i=>i(e,t)))}}function p(e,t,i,n,r,a=""){d.getInstance().sendScenarioEvent(e,t,i,n,r,a)}function h(e,t,i,n,r,a=""){d.getInstance().sendLoggingEvent(e,t,i,a,n,r)}function m(e,t,i,n,r,a,s=""){d.getInstance().sendTelemetry(e,t,i,n,r,a,s)}function u(e){d.getInstance().sendHeartbeatEvent(e)}function g(e){d.getInstance().registerEventDecorator(e)}},586207:(e,t,i)=>{var n;i.d(t,{f:()=>P}),function(e){e.p720="720p",e.p1080="1080p",e.p2k="2k",e.p4k="4k",e.unkown="unkown"}(n||(n={}));const r=2073600,a=3686400,s=8294400;async function o(e){const t={Perf_Screen:void 0};let i;const o=e.screen.availWidth*e.screen?.availHeight;return i=o<r?n.p720:o>=r&&o<a?n.p1080:o>=a&&o<s?n.p2k:o>=s?n.p4k:n.unkown,t.Perf_Screen={width:e.screen?.availWidth,height:e.screen?.availHeight,resolution:i,dpr:e.devicePixelRatio},Promise.resolve(t)}var c=i(210841),l=i(754255),d=i(850434),p=i(817542),h=i(328801);async function m(e,t,i){const n={workers:[],processes:[],windows:[]},r=await(e?.loadModule("heartbeat"));if(!r?.getPerfMetrics)return n;const a=n;try{let e;if(i&&r.getPerfMetricsAsync){let i;try{i=await r.getPerfMetricsAsync()}catch(e){return t.errorToTelemetry?.("get-webview-2-metrics, getMetrics: Failed to get async metrics.","fundamentals_performance_get_webview2_metrics"),n}e=i.processes,a.windows=i.windows;for(const e of i.workers)a.workers.push({targetSessionId:e.targetSessionId,type:e.type,subType:e.subType,url:e.url,totalSizeKB:(0,h.vr)(e.totalSizeBytes),usedSizeKB:(0,h.vr)(e.usedSizeBytes)})}else try{e=await r.getPerfMetrics()}catch(e){return t.errorToTelemetry?.("get-webview-2-metrics, getMetrics: Failed to get metrics.","fundamentals_performance_get_webview2_metrics"),n}for(const t of e)a.processes.push({processId:t.processId,name:t.name,type:t.type,utilitySubType:t.utilitySubType,embeddedBrowserWebView:t.embeddedBrowserWebView,cpuCycleTime:t.cpuCycleTime,workingSetSizeKB:(0,h.vr)(t.workingSetSizeBytes),privateWorkingSetSizeKB:(0,h.vr)(0===t.privateWorkingSetSizeBytes?void 0:t.privateWorkingSetSizeBytes),commitSizeKB:(0,h.vr)(t.pageFileUsageBytes),isMainRenderer:t.isMainRenderer??!1})}catch(e){return t.errorToTelemetry?.("get-webview-2-metrics, getMetrics: Failed to process metrics.","fundamentals_performance_get_webview2_metrics"),n}return a}var u=i(364819);class g{constructor(e,t,i){this.hostCommunicationService=t,this.uuidToAppIdMap={},this.cmsObjects=[],this.trackAppCountOnly=i,this.logger=e.newLogger("PlatformAppsManagementService","core-services-telemetry")}updateAppCountTrackingFlag(e){e!==this.trackAppCountOnly&&(this.trackAppCountOnly=e)}async getTelemetry(){return this.getPlatformAppsStats()}async getAppsPerfMetrics(){return this.getPlatformAppsStats(!0)}addCacheManagementService(e){return this.cmsObjects.find((t=>t===e))?(this.logger.errorToTelemetry?.("addCacheManagementService: cms exists in appManagementService","platform_app_caching_cms_exists_in_app_management_service",void 0,!0),!1):(this.cmsObjects.push(e),!0)}removeCacheManagementService(e){return this.cmsObjects.splice(this.cmsObjects.indexOf(e),1),!0}addApp(e,t,i,n){return this.uuidToAppIdMap.hasOwnProperty(e)?(this.logger.errorToTelemetry?.("addApp: App exists in appManagementService","platform_app_exists_in_app_management_service",{"App.Id":t},!0),!1):(this.uuidToAppIdMap[e]={appId:t,managedByCache:i,isPrecachedApp:n},!0)}removeApp(e){return this.uuidToAppIdMap[e]?(delete this.uuidToAppIdMap[e],!0):(this.logger.errorToTelemetry?.("removeApp: App is not in uuid map","platform_app_missing_in_uuid_map",void 0,!0),!1)}removeLeastRecentlyUsedApp(e){if(this.isInCacheStabilizationPeriod())return void this.logger.log("removeLeastRecentlyUsedApp skipped due to stabilization period");let t;for(const e of this.cmsObjects){const i=e.getLeastRecentlyUsedApp();i&&(i.uuid&&i.timeInCache&&(void 0===t||i.timeInCache<t.timeInCache)&&(t={frameUuid:i.uuid,cmsObject:e,timeInCache:i.timeInCache}))}if(t?.frameUuid){const i=this.uuidToAppIdMap[t.frameUuid];i?.appId&&t.cmsObject.removeByAms(i?.appId,e)}}isInCacheStabilizationPeriod(){return this.cmsObjects.some((e=>e.isInCacheStabilizationPeriod()))}findProcessInfo(e,t){if(!t)return;const i=e.processes.find((e=>e.processId===t));return i?{workingSetSize:i.workingSetSizeKB,commitSize:i.commitSizeKB,cpuCycleTime:i.cpuCycleTime}:void 0}computeSizeOfFrames(e,t,i){const{memoryMetrics:n,processVisitedMap:r,appsVisited:a,isActiveApp:s,appsStats:o,perAppFrameData:c,frames:l,treeLevel:d}=e;for(const p of l){p.platformFrameUuid&&(s?o.activeAppsCount+=1:o.cachedAppsCount+=1);const l=this.findProcessInfo(n,p.processId);if(!l)return;const h=l.workingSetSize||0,m=l.commitSize||0;if(p.processId)if(r[p.processId]){const e=r[p.processId];e.currentFrameUuid!==i&&(e.currentFrameUuid=i,c.totalFrameWorkingSetSizeKB+=h,c.totalFrameCommitSizeKB+=m,c.maxCpuCycleTime=Math.max(c.maxCpuCycleTime,l.cpuCycleTime)),e.appIds.find((e=>e===t))||(e.appIds.push(t),a[t]&&this.addPerAppMetricsInfo(a[t],m,h))}else r[p.processId]={frame:p,currentFrameUuid:i,appIds:[t]},this.addAppStatsInfo(s,h,m,o),a[t]&&this.addPerAppMetricsInfo(a[t],m,h),c.totalFrameWorkingSetSizeKB+=h,c.totalFrameCommitSizeKB+=m,c.maxCpuCycleTime=Math.max(c.maxCpuCycleTime,l.cpuCycleTime);c.frameInfo.push({processId:p.processId,workingSetSizeKB:l.workingSetSize,cpuCycleTime:l.cpuCycleTime,treeLevel:d}),this.computeSizeOfFrames({...e,frames:p.frames,treeLevel:d+1},t,i)}}isActiveApp(e){let t=!1;for(const i of this.cmsObjects){const n=i.isAppCached(e);if(void 0!==n&&(t=!n,t))break}return t}async getPlatformAppsStats(e){const t={activeWorkingSetSizeKB:0,cachedWorkingSetSizeKB:0,activeCommitSizeKB:0,cachedCommitSizeKB:0,activeAppsCount:0,cachedAppsCount:0,appsPlatformFrameStats:[],appsPlatformStats:[]};if(!this.hostCommunicationService)return;const i=await m(this.hostCommunicationService,this.logger,!0),n={},r={},a={windows:i.windows,appsVisited:r,processVisitedMap:n,processVisitedMapPerApp:{},memoryMetrics:i,appsStats:t,includeFrameUuid:e};if(this.trackAppCountOnly){const{cachedAppsCount:e,activeAppsCount:i}=this.processCachedAppCount();return{...t,cachedAppsCount:e,activeAppsCount:i}}this.processMemoryInformation({...a,computeActiveApps:!0}),this.processMemoryInformation({...a,computeActiveApps:!1});for(const e of Object.keys(r)){const i=r[e];if(i){for(const t of Object.keys(n)){const{appIds:r}=n[t];if(r.find((t=>t===e))&&r.length>1){i.isSharingProcess=!0;break}}t.appsPlatformStats.push(i)}}return t}addPerAppMetricsInfo(e,t,i){e.totalAppCommitSizeKB+=t,e.totalAppWorkingSetSizeKB+=i}addAppStatsInfo(e,t,i,n){e?(n.activeWorkingSetSizeKB+=t,n.activeCommitSizeKB+=i):(n.cachedWorkingSetSizeKB+=t,n.cachedCommitSizeKB+=i)}processCachedAppCount(){let e=0,t=0;const i=Object.keys(this.uuidToAppIdMap);for(const n of i){const i=this.uuidToAppIdMap[n];!i?.managedByCache||this.isActiveApp(n)?e+=1:t+=1}return{cachedAppsCount:t,activeAppsCount:e}}processMemoryInformation(e){const{windows:t,computeActiveApps:i,appsStats:n,memoryMetrics:r,processVisitedMap:a,appsVisited:s,includeFrameUuid:o}=e;for(const e of t)for(const t of e.frames){if(!t.platformFrameUuid)continue;const c=this.uuidToAppIdMap[t.platformFrameUuid],l=!c?.managedByCache||this.isActiveApp(t.platformFrameUuid),d=c?.isPrecachedApp;if(c&&c.appId&&!s[c.appId]&&(s[c.appId]={appId:c.appId,isSharingProcess:!1,totalAppCommitSizeKB:0,totalAppWorkingSetSizeKB:0}),l===!i)continue;const p={windowId:e.windowId,isCached:!l,isPrecachedApp:d,totalFrameWorkingSetSizeKB:0,totalFrameCommitSizeKB:0,maxCpuCycleTime:0,frameInfo:[],appId:c?.appId??"",platformFrameUuid:o?t.platformFrameUuid:void 0};this.computeSizeOfFrames({frames:[t],appsStats:n,memoryMetrics:r,perAppFrameData:p,isActiveApp:l,processVisitedMap:a,appsVisited:s,treeLevel:0},p.appId,p.platformFrameUuid),n.appsPlatformFrameStats.push(p)}}}var S=i(339953),f=i(757346);class v{constructor(e,t,i){this.leakDetectorService=t,this.fallbackHost=i,this.logger=e.newLogger("StyleMetricsService","core-services-telemetry"),this.currentStyles=this.getCurrentStyles()}getTelemetry(){const e=this.getCurrentStyles(),t=e-this.currentStyles;return t>0&&this.logger.warn(`Style count increased by ${t} since last heartbeat. New Style count: ${e}`),this.currentStyles=e,{Style_Count:e,Style_Delta:t}}getPrimaryWindow(){const e=this.leakDetectorService?.getReachableObjects(f.J.UnwrappedWindow);return e&&0!==e.size?Array.from(this.leakDetectorService?.getReachableObjects(f.J.UnwrappedWindow)).find((e=>e.windowLeakInfo?.windowLeakInfoViewportContext===S.k.primary)):this.fallbackHost}getCurrentStyles(){const e=this.getPrimaryWindow();return e?Array.from(e.document.styleSheets).filter((e=>!e.href)).flatMap((e=>Array.from(e.cssRules))).length:0}}var k=i(665360),y=i(5975);const C=[c.Lg.LongInactive],b=e=>C.includes(e),_=e=>e.map((e=>e.processId)).concat(...e.map((e=>_(e.frames)))).filter((e=>void 0!==e));class P{constructor(e){this.context=e,this.isRunning=!1,this.timeouts={},this.lastBeatTimes={},this.intervals={},this.granularNativeMetrics=[],this.granularWorkerMetrics=[],this.packedCallingData=new Map,this.peakWorkingSetByProcess=new Map,this.peakUsedJSHeapSize=0,this.granularJSHeapMetrics=[],this.getHeartbeatStandardInterval=()=>this._configuration?.intervalInSeconds??Number.MAX_SAFE_INTEGER,this.getHeartbeatInterval=e=>{const t=this.getHeartbeatStandardInterval(),i=this._configuration?.maxIntervalInSeconds??t,n=Math.max(1,this._configuration?.delayFactor??1),r=this.context.clientState?.getState();return r&&b(r)?Math.min(i,Math.max(e,t)*n):t},this.getMemorySubInterval=()=>this._configuration?.memoryMetricsCollection?.collectionIntervalInSeconds??Number.MAX_SAFE_INTEGER,this.logger=e.loggerFactory.newLogger("Heartbeat","core-services-telemetry");const{enableAppCountTracking:t}=e.coreSettings.get(l.w.Extensibility);this.platformAppsManagementService=new g(e.loggerFactory,e.hostCommunicationService,!!t),this.styleMetricsService=new v(e.loggerFactory,e.leakDetectorService,e.windowProvider)}static getInstance(){return P.instance}get configuration(){return this._configuration}getPlatformAppsService(){return this.platformAppsManagementService}async start(){P.instance||(P.instance=this,this.logger.debug("Starting the monitor..."),this.initializedTime=Date.now(),this.subscribeToCoreSettings(),this.subscribeToClientState(),await this.registerScenarios())}isHeartbeatMonitorRunning(){return this.isRunning}async getMemoryData(e){if(this._configuration?.memoryMetricsCollection?.enabled){if(e)return this.getAverageMemoryMetrics();if(this.isRunning){const{jsHeapMetrics:e,nativeMemoryMetrics:t,hasExtraRenderer:i}=await this.getMemoryAndJSHeapData();return{...e&&(0,h.Cd)(e,this.peakUsedJSHeapSize),...t&&(0,h.Ac)(t.processes,this.peakWorkingSetByProcess,this.mainRendererProcessId),...t&&(0,h.EE)(t.workers),hasExtraRenderer:i}}}return{}}async collectData(){const e=this.getActions().map((async e=>{try{return await e()}catch{return this.logger.errorToTelemetry?.(`call to function '${e}' failed in heartbeat monitor.`,"fundamentals_performance_heartbeat_monitor"),{}}}));return Object.assign.apply(Object,await Promise.all(e))}collectCallingData(e,t){const{enableCallingCDLTrackingNS:i}=this.context.coreSettings.get(l.w.Calling)||{};this.packedCallingData.set(e,(this.packedCallingData.get(e)??[]).concat(i?{...t,cdlData:this.context.graphqlOpsCountService?.getLatestDataAndClear()}:t))}setLoopVersion(e){e&&(!this.loopVersion||e>this.loopVersion)&&(this.loopVersion=e)}getActions(){const e=[];e.push(this.getLoopVersion.bind(this)),this._configuration?.memoryMetricsCollection?.enabled&&e.push(this.getAverageMemoryMetrics.bind(this)),this._configuration?.simpleCollabMetricsCollection?.enabled&&e.push(this.getIsSimpleCollabEnabled.bind(this)),this._configuration?.elapsedTimeTracking?.enabled&&e.push(this.getElapsedTime.bind(this)),this._configuration?.screenInfoCollection?.enabled&&e.push(o.bind(this,this.context.windowProvider)),this._configuration?.inpMetricsCollection?.enabled&&e.push(this.getInpMetrics.bind(this)),this._configuration?.ariMetricsCollection?.enabled&&e.push(this.getAriMetrics.bind(this)),this._configuration?.dataClientMetricsCollection?.enabled&&e.push(this.getDataClientMetrics.bind(this)),this._configuration?.windowMetricsCollection?.enabled&&e.push(this.getWindowMetrics.bind(this)),this._configuration?.clientStateMetricsCollection?.enabled&&e.push(this.getClientStateMetrics.bind(this)),this._configuration?.OLDMetricsCollection?.enabled&&e.push(this.getObjectLeakDetectorMetrics.bind(this));const{enableCallingDataCollectionInHeartbeatConfig:t}=this.context.coreSettings?.get(l.w.Calling)||{};return t&&this._configuration?.callingDataCollection?.enabled&&e.push(this.getCallingData.bind(this)),this._configuration?.graphqlStoreMetricsCollection?.enabled&&e.push(this.getGraphQLStoreMetrics.bind(this)),this._configuration?.platformAppMetricsCollection?.enabled&&e.push(this.getPlatformAppsMetrics.bind(this)),this._configuration?.styleMetricsCollection?.enabled&&e.push(this.getStyleMetrics.bind(this)),this._configuration?.vdiMetricsCollection?.enabled&&e.push(this.getVdiMetrics.bind(this)),this._configuration?.slimcoreVersionCollection?.enabled&&e.push(this.getSlimcoreVersionMetric.bind(this)),e}stopHeartbeat(){this.isRunning&&this.logger.debug("stopping heartbeat monitor"),Object.keys(this.timeouts).forEach((e=>{this.context.windowProvider.clearTimeout(this.timeouts[e])})),this.timeouts={},this.isRunning=!1}subscribeToCoreSettings(){const e=this.context.coreSettings.getObservable(l.w.Telemetry,["enableHeartbeatMonitor","heartbeatConfiguration"]),t=this.context.coreSettings.getObservable(l.w.Extensibility,["enableAppCountTracking"]);let i=this.context.coreSettings.get(l.w.Telemetry).heartbeatConfiguration;e.subscribe((e=>{const{enableHeartbeatMonitor:t,heartbeatConfiguration:n}=e;n?(this._configuration=n,this.logger.debug("Configuration loaded...",this._configuration)):t&&this.logger.errorToTelemetry?.("'heartbeatConfiguration' not found.","fundamentals_performance_heartbeat_monitor"),t?(this.startHeartbeat(),this._configuration?.memoryMetricsCollection?.enabled||(this.context.windowProvider.clearTimeout(this.timeouts.memory),this.timeouts.memory=void 0)):(this._configuration=void 0,this.stopHeartbeat()),this._configuration?.intervalInSeconds&&i?.intervalInSeconds!==this._configuration?.intervalInSeconds&&this.overrideNextBeat(),i=this._configuration})),t.subscribe((e=>{const{enableAppCountTracking:t}=e;this.platformAppsManagementService.updateAppCountTrackingFlag(!!t)}))}startHeartbeat(){!this.isRunning&&this.logger.debug("starting heartbeat monitor"),this.scheduleNextTimeout("heartbeat",this.isRunning?this.getHeartbeatInterval(0):Math.min(30,this.getHeartbeatInterval(0)),this.beat.bind(this),this.getHeartbeatInterval,!1),this.scheduleNextTimeout("memory",this.isRunning?this.getMemorySubInterval():Math.min(25,this.getMemorySubInterval()),this.collectGranularMemoryAndJSHeapData.bind(this),this.getMemorySubInterval,!1),this.isRunning=!0}overrideNextBeat(){if(!this.isRunning)return;const e=this.getHeartbeatInterval(0)*d.f2.second,t=Date.now(),i=((this.lastBeatTimes.heartbeat??this.initializedTime??t)+e-t)/d.f2.second;this.scheduleNextTimeout("heartbeat",i>0?i:0,this.beat.bind(this),this.getHeartbeatInterval,!0)}subscribeToClientState(){const{clientState:e}=this.context;if(!e)return void this.context.windowProvider.setTimeout((()=>this.subscribeToClientState()),100);this.logger.log("Client state is available, preparing subscription");const t=e.observe();let i=e.getState();t.subscribe({next:e=>{b(i)&&!b(e)&&this.overrideNextBeat(),i=e}})}scheduleNextTimeout(e,t=Number.MAX_SAFE_INTEGER,i,n,r){const a=t*d.f2.second;0<=a&&a<2147483647&&(r&&this.timeouts[e]&&(this.context.windowProvider.clearTimeout(this.timeouts[e]),this.timeouts[e]=void 0),this.timeouts[e]||(this.intervals[e]=t,this.timeouts[e]=this.context.windowProvider.setTimeout((async()=>{this.timeouts[e]=void 0;try{await i()}catch{this.logger.errorToTelemetry?.(`call to function '${i}' failed in heartbeat monitor.`,"fundamentals_performance_heartbeat_monitor")}finally{this.lastBeatTimes[e]=Date.now(),this.scheduleNextTimeout(e,n(t),i,n,!1)}}),a)))}async beat(){const e=await this.collectData();(0,p.ni)(e)}getElapsedTime(){const e=Date.now(),t=this.initializedTime||e;return{elapsed:Math.floor((e-t)/d.f2.second)}}async getIsSimpleCollabEnabled(){const e={Perf_SimpleCollab_ViewType:void 0};return e.Perf_SimpleCollab_ViewType=await this.fetchSimpleCollabViewType(),e}async fetchSimpleCollabViewType(){const{enableSimpleCollabApp:e,enableSimpleCollabAppToggle:t,enableSimpleCollabAppSplitView:i}=this.context.coreSettings.get(l.w.SimpleCollab);let n;if(e&&t){let r={};try{const{data:e}=await this.context.client.query({query:y.W,fetchPolicy:"cache-only"}),t=e?.userPreferencesForSimpleCollab;t&&"simpleCollabUserSettings"in t&&t.simpleCollabUserSettings&&(r=t.simpleCollabUserSettings)}catch{r={}}finally{n=(0,k.Dt)(!!e,!!t,!!i,r)}}return n}getLoopVersion(){return{AppInfo_Loop_Version:this.loopVersion}}getAverageMemoryMetrics(){const e=[];if(this.granularNativeMetrics.length){const t=new Map(this.peakWorkingSetByProcess.entries());this.peakWorkingSetByProcess.clear(),this.granularNativeMetrics.reduce(((e,t)=>{for(const i of t){const{processId:t}=i;e.set(t,(e.get(t)??[]).concat(i))}return e}),new Map).forEach(((i,n)=>{this.peakWorkingSetByProcess.set(n,t.get(n)??0);const r=(0,u.meanBy)(i,(e=>e.workingSetSizeKB)),a=(0,u.meanBy)(i,(e=>e.privateWorkingSetSizeKB)),s=(0,u.meanBy)(i,(e=>e.commitSizeKB)),o={processId:n,name:i[0].name,type:i[0].type,utilitySubType:i[0].utilitySubType,embeddedBrowserWebView:i[0].embeddedBrowserWebView,cpuCycleTime:i[0].cpuCycleTime,workingSetSizeKB:isNaN(r)?void 0:Math.round(r),privateWorkingSetSizeKB:isNaN(a)?void 0:Math.round(a),commitSizeKB:isNaN(s)?void 0:Math.round(s)};e.push(o)}))}const t=[];this.granularWorkerMetrics.length&&this.granularWorkerMetrics.reduce(((e,t)=>{for(const i of t){const{targetSessionId:t}=i;e.set(t,(e.get(t)??[]).concat(i))}return e}),new Map).forEach(((e,i)=>{const n=(0,u.meanBy)(e,(e=>e.totalSizeKB)),r=(0,u.meanBy)(e,(e=>e.usedSizeKB)),a={targetSessionId:i,type:e[0].type,subType:e[0].subType,url:e[0].url,totalSizeKB:isNaN(n)?void 0:Math.round(n),usedSizeKB:isNaN(r)?void 0:Math.round(r)};t.push(a)}));const i=(0,h.Ac)(e,this.peakWorkingSetByProcess,this.mainRendererProcessId),n=(0,h.EE)(t);let r={};if(this.granularJSHeapMetrics.length){const e={jsHeapSizeLimit:Math.round((0,u.meanBy)(this.granularJSHeapMetrics,(e=>e.jsHeapSizeLimit||0))),totalJSHeapSize:Math.round((0,u.meanBy)(this.granularJSHeapMetrics,(e=>e.totalJSHeapSize||0))),usedJSHeapSize:Math.round((0,u.meanBy)(this.granularJSHeapMetrics,(e=>e.usedJSHeapSize||0)))};r=(0,h.Cd)(e,this.peakUsedJSHeapSize)}const a={...i,...n,...r,hasExtraRenderer:this.hasExtraRenderer};return this.hasExtraRenderer=void 0,a}getInpMetrics(){const e={Perf_Inp:""};if(this.context.interactionToNextPaintService){const t=this.context.interactionToNextPaintService.getTelemetry();e.Perf_Inp=t}return e}getAriMetrics(){const e={Perf_Ari:""};if(this.context.appResponsivenessService){const t=this.context.appResponsivenessService.getTelemetry();e.Perf_Ari=t}return e}getDataClientMetrics(){const e={Perf_ApolloCacheStats:void 0};if(this.context.dataClientTrackingService){const t=this.context.dataClientTrackingService.getTelemetry();e.Perf_ApolloCacheStats=t}return e}getWindowMetrics(){const e={Perf_WindowStats:void 0};if(this.context.windowTrackerService){const t=this.context.windowTrackerService.getTelemetry();e.Perf_WindowStats=t}return e}getObjectLeakDetectorMetrics(){const e={};if(this.context.leakDetectorService){const t=this.context.leakDetectorService.getTelemetry();if(t){const{counts:i,leakStats:n,leaks:r,countsRecord:a,hasWindowLeak:s,hasApolloLeak:o}=t;e.Perf_OLDStats=i,e.Perf_LeakStats=n,e.Perf_Leaks=r,e.Perf_LeaksRecord=a,e.Perf_Leaks_HasWindowLeak=s,e.Perf_Leaks_HasApolloLeak=o}}return e}getClientStateMetrics(){const e={Perf_IsUserInCall:void 0};if(this.context.clientState){const t=this.context.clientState.getState()===c.Lg.VeryActive;e.Perf_IsUserInCall=t}return e}getCallingData(){const e={Perf_Calling_Data:void 0,Perf_HasCallingData:void 0,Perf_IsScreenSharing:void 0,Perf_IsReceivingScreenSharing:void 0,Perf_IsSendingContentSharing:void 0,Perf_IsReceivingContentSharing:void 0,Perf_IsVideoOn:void 0},t=[];for(const[,e]of this.packedCallingData)t.push(...e);return e.Perf_HasCallingData=t.length>0,e.Perf_HasCallingData&&(e.Perf_Calling_Data=t.map((e=>JSON.stringify(e))),e.Perf_IsScreenSharing=t.some((e=>e?.callDataBag?.isScreenSharing)),e.Perf_IsReceivingScreenSharing=t.some((e=>e?.callDataBag?.isReceivingScreenSharing)),e.Perf_IsSendingContentSharing=t.some((e=>e?.callDataBag?.isSendingContentSharing)),e.Perf_IsReceivingContentSharing=t.some((e=>e?.callDataBag?.isReceivingContentSharing)),e.Perf_IsVideoOn=t.some((e=>e?.callDataBag?.isVideoOn))),this.packedCallingData.clear(),e}getGraphQLStoreMetrics(){const e={};return this.context.graphqlStoreStatsReporterService&&(e.Perf_GraphQLStoreStats=this.context.graphqlStoreStatsReporterService.getTelemetry()),e}async getPlatformAppsMetrics(){let e={};const t=await this.platformAppsManagementService.getTelemetry();return t&&(e={Perf_PlatformApps_Active_WorkingSet:t.activeWorkingSetSizeKB,Perf_PlatformApps_Cached_WorkingSet:t.cachedWorkingSetSizeKB,Perf_PlatformApps_Active_Commit_Size:t.activeCommitSizeKB,Perf_PlatformApps_Cached_Commit_Size:t.cachedCommitSizeKB,Perf_PlatformApps_Count_CachedApps:t.cachedAppsCount,Perf_PlatformApps_Count_ActiveApps:t.activeAppsCount,Perf_PlatformApps_Frame_Stats:t.appsPlatformFrameStats,Perf_PlatformApps_Stats:t.appsPlatformStats}),e}getStyleMetrics(){return this.styleMetricsService.getTelemetry()}getVdiMetrics(){return{vdiMode:this.context.platformService?.config.vdi?.mode??""}}getSlimcoreVersionMetric(){return{slimCoreVersion:this.context.windowProvider.SlimCore?.getVersion().toString()||""}}async getMemoryAndJSHeapData(){let e,t,i;if(this.context.hostCommunicationService){e=await m(this.context.hostCommunicationService,this.logger,this._configuration?.workerMetricsCollection?.enabled||!1);const t=[];let n=0;for(const i of e.processes){const{type:e,isMainRenderer:r,processId:a}=i;"renderer"===e.toLowerCase()&&(r&&(n=a),t.push(i))}this.mainRendererProcessId=this.mainRendererProcessId&&t.find((e=>e.processId===this.mainRendererProcessId))?this.mainRendererProcessId:n||t.sort(((e,t)=>(t.workingSetSizeKB??0)-(e.workingSetSizeKB??0)))[0]?.processId;const r=e.windows.flatMap((e=>[e.processId,..._(e.frames)]));i=t.length>0&&!t.every((e=>e.isMainRenderer||r.includes(e.processId)))}else this.logger.errorToTelemetry?.("Invalid hostCommunicationService, cannot get native metrics from Desktop","fundamentals_performance_heartbeat_monitor");return this.context.windowProvider?t=function(e){const t=e.performance;let i,n,r;const a=t?.memory;return a&&(i=(0,h.vr)(a.jsHeapSizeLimit),n=(0,h.vr)(a.totalJSHeapSize),r=(0,h.vr)(a.usedJSHeapSize)),{jsHeapSizeLimit:i,totalJSHeapSize:n,usedJSHeapSize:r}}(this.context.windowProvider):this.logger.errorToTelemetry?.("Invalid windowProvider, cannot get js metrics from window","fundamentals_performance_heartbeat_monitor"),{nativeMemoryMetrics:e,jsHeapMetrics:t,hasExtraRenderer:i}}async collectGranularMemoryAndJSHeapData(){const{nativeMemoryMetrics:e,jsHeapMetrics:t,hasExtraRenderer:i}=await this.getMemoryAndJSHeapData(),n=this.intervals.heartbeat??this.getHeartbeatStandardInterval(),r=Math.max(Math.round(n/this.getMemorySubInterval()),1)||1;if(e){this.granularNativeMetrics=this.granularNativeMetrics.concat([e.processes]).slice(-r),this.granularWorkerMetrics=this.granularWorkerMetrics.concat([e.workers]).slice(-r);for(const t of e.processes){const{processId:e}=t,i=this.peakWorkingSetByProcess.get(e);this.peakWorkingSetByProcess.set(e,Math.max(i||0,t.workingSetSizeKB||0))}}t&&(this.peakUsedJSHeapSize=Math.max(this.peakUsedJSHeapSize,t.usedJSHeapSize||0),this.granularJSHeapMetrics=this.granularJSHeapMetrics.concat(t).slice(-r)),this.hasExtraRenderer||(this.hasExtraRenderer=i)}async registerScenarios(){if(this.context.hostCommunicationService){const e=await this.context.hostCommunicationService.loadModule("heartbeat");if(e?.registerForScenarioStart)try{e.registerForScenarioStart((e=>{}))}catch{this.logger.error("Failed to register for listening to host scenarios starting")}if(e?.registerForScenarioStop)try{e.registerForScenarioStop((e=>{}))}catch{this.logger.error("Failed to register for listening to host scenarios stopping")}}}}P.instance=void 0},757010:(e,t,i)=>{i.d(t,{F:()=>n});const n={kind:"Document",definitions:[{kind:"FragmentDefinition",name:{kind:"Name",value:"meetingInformationFields"},typeCondition:{kind:"NamedType",name:{kind:"Name",value:"MeetingInformation"}},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"}},{kind:"Field",name:{kind:"Name",value:"iCalUid"}},{kind:"Field",name:{kind:"Name",value:"scenario"}},{kind:"Field",name:{kind:"Name",value:"meetingJoinUrl"}},{kind:"Field",name:{kind:"Name",value:"meetingType"}},{kind:"Field",name:{kind:"Name",value:"meetingData"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"meetingCode"}},{kind:"Field",name:{kind:"Name",value:"passcode"}},{kind:"Field",name:{kind:"Name",value:"meetingUrl"}}]}},{kind:"Field",name:{kind:"Name",value:"isCancelled"}},{kind:"Field",name:{kind:"Name",value:"startTime"}},{kind:"Field",name:{kind:"Name",value:"endTime"}},{kind:"Field",name:{kind:"Name",value:"eventType"}},{kind:"Field",name:{kind:"Name",value:"isRecurring"}},{kind:"Field",name:{kind:"Name",value:"organizerId"}},{kind:"Field",name:{kind:"Name",value:"tenantId"}},{kind:"Field",name:{kind:"Name",value:"eventRecurrenceRange"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"startDate"}},{kind:"Field",name:{kind:"Name",value:"endDate"}}]}},{kind:"Field",name:{kind:"Name",value:"eventRecurrencePattern"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"patternType"}},{kind:"Field",name:{kind:"Name",value:"daily"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"interval"}}]}},{kind:"Field",name:{kind:"Name",value:"weekly"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"daysOfTheWeek"}},{kind:"Field",name:{kind:"Name",value:"interval"}}]}},{kind:"Field",name:{kind:"Name",value:"monthly"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"dayOfMonth"}},{kind:"Field",name:{kind:"Name",value:"interval"}}]}},{kind:"Field",name:{kind:"Name",value:"relativeMonthly"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"dayOfTheWeekIndex"}},{kind:"Field",name:{kind:"Name",value:"dayOfTheWeek"}},{kind:"Field",name:{kind:"Name",value:"interval"}}]}},{kind:"Field",name:{kind:"Name",value:"yearly"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"month"}},{kind:"Field",name:{kind:"Name",value:"dayOfTheMonth"}}]}},{kind:"Field",name:{kind:"Name",value:"relativeYearly"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"month"}},{kind:"Field",name:{kind:"Name",value:"dayOfTheWeekIndex"}},{kind:"Field",name:{kind:"Name",value:"dayOfTheWeek"}}]}}]}},{kind:"Field",name:{kind:"Name",value:"resolvedSensitivityLabelId"}},{kind:"Field",name:{kind:"Name",value:"isCopyRestrictionEnforced"}},{kind:"Field",name:{kind:"Name",value:"templateDetails"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"id"}}]}},{kind:"Field",name:{kind:"Name",value:"messagingPolicy"},selectionSet:{kind:"SelectionSet",selections:[{kind:"Field",name:{kind:"Name",value:"textOnlyChat"}}]}}]}}]}},328801:(e,t,i)=>{i.d(t,{EE:()=>a,Ac:()=>s,Cd:()=>o,vr:()=>c,VQ:()=>l});var n=i(364819);const r=1024;function a(e){const t={},i=[...e];return S(t,"TelemetryWorker",y(i,"TelemetryWorker")),S(t,"CDLWorker",y(i,"CDLWorker")),S(t,"ServiceWorker",y(i,"ServiceWorker")),S(t,"UnknownWorker",i),t.Perf_Unknown_Workers=i,t.Perf_TotalWorker_UsedSize=h(e),t.Perf_TotalWorker_TotalSize=p(e),t.Perf_Total_NumberOfWorkers=e.length,t}function s(e,t,i){const n={},r=[...e];f(n,"GPU",k(r,["gpu-process","Gpu"]),t),f(n,"NativeShell",k(r,["nativeShell","NativeShell"]),t),f(n,"CrashpadHandler",k(r,"crashpad-handler"),t),f(n,"Browser",k(r,["browser","Browser"]),t);const a=k(r,["renderer","Renderer"]);n.Perf_Renderer_Count_Processes=a.length,f(n,"Renderer",a,t),f(n,"SlimCore",k(r,["NativeModuleProcess_SlimCore"]),t);const s=k(r,["utility","Utility"]);if(f(n,"Utility",s,t),n.Perf_Utility_Process=[...s],f(n,"Total",e),n.Perf_Total_NumberOfProcesses=e.length,n.Perf_Unknown_Process=r,n.Perf_Unknown_NumberOfProcesses=r.length,n.Perf_Unknown_WorkingSet=m(r),n.Perf_Unknown_PrivateWorkingSet=u(r),n.Perf_Unknown_CommitSize=g(r),i){const r=e.find((e=>e.processId===i));r&&(n.Perf_MainRenderer_WorkingSet=m([r]),n.Perf_MainRenderer_PrivateWorkingSet=u([r]),n.Perf_MainRenderer_CommitSize=g([r]),n.Perf_MainRenderer_PeakWorkingSet=t?.get(i))}return n}function o(e,t){const i={},{totalJSHeapSize:n,jsHeapSizeLimit:r,usedJSHeapSize:a}=e;return n&&(i.Perf_JSHeap_TotalSize=n),r&&(i.Perf_JSHeap_LimitSize=r),a&&(i.Perf_JSHeap_UsedSize=a),t&&(i.Perf_Peak_UsedJSHeapSize=t),i}function c(e){return"number"!=typeof e||isNaN(e)?void 0:Math.round(e/r)}const l=c;function d(e,t){const i=(0,n.sumBy)(e,(e=>e[t]??NaN));return 0===e.length||isNaN(i)?void 0:i}function p(e){return d(e,"totalSizeKB")}function h(e){return d(e,"usedSizeKB")}function m(e){return d(e,"workingSetSizeKB")}function u(e){return d(e,"privateWorkingSetSizeKB")}function g(e){return d(e,"commitSizeKB")}function S(e,t,i){e[`Perf_${t}_UsedSize`]=h(i),e[`Perf_${t}_TotalSize`]=p(i),e[`Perf_Total_NumberOf${t}s`]=i.length}function f(e,t,i,n){if(e[`Perf_${t}_WorkingSet`]=m(i),e[`Perf_${t}_PrivateWorkingSet`]=u(i),e[`Perf_${t}_CommitSize`]=g(i),"Total"===t)e.Perf_Total_NumberOfProcesses=i.length;else{if(e[`Perf_${t}_Count_Processes`]=i.length,!n||!i.length)return;const r=Math.max(...i.map((e=>n.get(e.processId)||0)));r&&(e[`Perf_${t}_PeakWorkingSet`]=r)}}function v(e,t){let i;const n=[];for(;i=e.findIndex(t),-1!==i;)n.push(e.splice(i,1)[0]);return n}function k(e,t){const i="string"==typeof t?[t]:t;return v(e,(e=>i.includes(e.type)))}function y(e,t){return v(e,(e=>e.subType.includes(t)))}}}]);
//# sourceMappingURL=https://local.teams.office.com/sourcemaps/hashed-assets/679609-ecbc6fe25bffc9a4.js.map